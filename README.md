# AnimeStream Glass v5

### Supabase SQL
```sql
-- Likes
create table if not exists anime_likes (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade,
  anime_id bigint not null,
  created_at timestamp default now()
);
create unique index if not exists anime_likes_user_anime_idx on anime_likes(user_id, anime_id);
alter table anime_likes enable row level security;
create policy if not exists "likes_select_all" on anime_likes for select using (true);
create policy if not exists "likes_insert_own" on anime_likes for insert with check (auth.uid() = user_id);
create policy if not exists "likes_delete_own" on anime_likes for delete using (auth.uid() = user_id);

create or replace function public.get_like_counts(anime_ids bigint[])
returns table (anime_id bigint, likes bigint)
language sql stable as $$
  select anime_id, count(*)::bigint as likes
  from anime_likes
  where anime_id = any(anime_ids)
  group by anime_id
  order by anime_id;
$$;
grant execute on function public.get_like_counts(bigint[]) to anon, authenticated;

-- Favorites RPC
create or replace function public.get_user_favorites(p_page int, p_page_size int)
returns table (id bigint, title text, image_url text, year int, score float8)
language sql security definer set search_path = public as $$
  select a.id, a.title, a.image_url, a.year, a.score
  from favorites f
  join anime a on a.id = f.anime_id
  where f.user_id = auth.uid()
  order by f.added_at desc
  offset greatest((p_page-1)*p_page_size,0)
  limit p_page_size;
$$;
revoke all on function public.get_user_favorites(int,int) from public;
grant execute on function public.get_user_favorites(int,int) to authenticated;

create or replace function public.get_user_favorites_count()
returns bigint language sql security definer set search_path = public as $$
  select count(*)::bigint from favorites f where f.user_id = auth.uid();
$$;
revoke all on function public.get_user_favorites_count() from public;
grant execute on function public.get_user_favorites_count() to authenticated;
```

### Not
- `favorites` & `anime` tabloları v3/v4 ile aynı kalsın.
- Email/Google auth açık olmalı.
```

